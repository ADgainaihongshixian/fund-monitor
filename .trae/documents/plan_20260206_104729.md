# 新浪财经基金历史数据API解决方案

## 问题分析

用户反馈使用 `/f10/FundArchivesDatas` 端点后仍然报错，错误信息显示 "404"，这表明这个API端点也不存在。天天基金网的API结构可能非常复杂，而且可能经常变更，导致多次尝试都失败了。

## 解决方案

### 1. 切换到新浪财经历史数据API

新浪财经的API具有以下优势：
- **稳定可靠**：API端点长期稳定，很少变更
- **格式简单**：返回CSV格式数据，易于解析
- **参数简单**：只需要基金代码即可
- **支持CORS**：不需要复杂的代理配置

### 2. 实施步骤

#### 步骤1：修改getFundHistory方法
- 将API端点从天天基金网切换到新浪财经
- 使用 `/list=f_${fundCode}` 端点获取历史数据
- 调整数据解析逻辑以适配CSV格式

#### 步骤2：更新请求参数
- 移除复杂的日期参数，新浪财经API会返回完整的历史数据
- 保持基金代码参数的完整性

#### 步骤3：修改数据解析逻辑
- 解析CSV格式的响应数据
- 提取日期、净值和涨跌幅信息
- 构建与现有代码兼容的数据结构

### 3. 技术实现

#### API调用代码
```typescript
// 构建新浪财经历史数据API请求URL
const url = `/list=f_${code.trim()}`;

// 发送请求
const response = await apiClient.get(url, {
  headers: {
    'Referer': 'https://finance.sina.com.cn/',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
  },
  responseType: 'text',
});
```

#### 数据解析逻辑
```typescript
// 解析CSV格式的响应数据
const historyData: { date: string; value: number; change: number }[] = [];

if (response) {
  const csvData = response as unknown as string;
  const lines = csvData.split('\n');
  
  // 跳过第一行（标题行），从第二行开始解析
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (line) {
      const parts = line.split(',');
      if (parts.length >= 3) {
        const date = parts[0];
        const value = parseFloat(parts[1]);
        const change = parseFloat(parts[2]);
        
        if (!isNaN(value)) {
          historyData.push({
            date,
            value,
            change: isNaN(change) ? 0 : change,
          });
        }
      }
    }
  }
  
  // 按日期排序（从旧到新）
  historyData.sort((a, b) => {
    return new Date(a.date).getTime() - new Date(b.date).getTime();
  });
  
  // 限制数据量，只返回最近days天的数据
  if (historyData.length > days) {
    historyData.splice(0, historyData.length - days);
  }
}
```

## 预期结果

- 接口能够正常返回基金历史净值数据
- 不再出现404错误
- 前端能够正确展示基金净值曲线图
- 接口稳定可靠，能够持续获取历史数据