# API接口替换实施方案

## 任务目标

将 `d:\fundMonitor\src\services\api.ts` 中的 `getFundData` 方法替换为使用 `http://fundgz.1234567.com.cn/js/{fundCode}.js` 接口，确保功能逻辑保持不变。

## 技术分析

### 当前实现

- 使用新浪财经API：`/api/sina/list=f_{fundCode}`
- 数据格式：文本格式，包含多个基金数据
- 数据解析：正则表达式提取数据部分，按逗号分割
- 返回结构：`FundData[]` 数组

### 新接口分析

- 使用天天基金网API：`http://fundgz.1234567.com.cn/js/{fundCode}.js`
- 数据格式：JSONP格式，单个基金数据
- 数据解析：需要处理JSONP包装，提取JSON数据
- 返回结构：单个基金的详细数据

## 实施方案

### 1. 修改API服务

**主要改动：**

1. **更新BASE_URL配置**：
   - 将新浪财经API的BASE_URL修改为天天基金网接口

2. **重写getFundData方法**：
   - 实现批量基金数据获取
   - 为每个基金代码单独调用API
   - 处理JSONP格式的响应
   - 按照字段映射关系转换数据

3. **字段映射**：
   - `dwjz` → `netValue`（单位净值）
   - `gsz` → `estimateValue`（估算净值）
   - `gszzl` → `estimateChange`（估算涨跌幅）
   - `gztime` → `lastUpdate`（估值时间）

### 2. 数据处理逻辑

**JSONP解析**：
```typescript
// 解析JSONP响应
const parseJSONP = (response: string): any => {
  const match = response.match(/jsonpgz\((.*?)\)/);
  if (match) {
    return JSON.parse(match[1]);
  }
  throw new Error('Invalid JSONP response');
};
```

**数据转换**：
```typescript
// 转换为FundData格式
const fundData: FundData = {
  code: data.fundcode,
  name: data.name,
  netValue: parseFloat(data.dwjz) || 0,
  estimateValue: parseFloat(data.gsz) || 0,
  estimateChange: parseFloat(data.gszzl) || 0,
  dayChange: parseFloat(data.gszzl) || 0, // 使用估算涨跌幅作为日涨跌幅
  lastUpdate: data.gztime,
  isRising: parseFloat(data.gszzl) >= 0
};
```

### 3. 批量处理逻辑

由于新接口一次只能获取一个基金的数据，需要实现批量处理：

1. 对每个基金代码单独调用API
2. 使用Promise.all并行处理多个请求
3. 汇总所有基金的数据
4. 保持与原接口相同的返回格式

### 4. 错误处理和缓存

- 保持原有的错误处理逻辑
- 保留缓存机制，减少API调用
- 确保错误时的返回格式一致

## 执行步骤

1. **修改BASE_URL**：更新API基础URL配置
2. **重写getFundData方法**：实现新的API调用逻辑
3. **添加JSONP解析函数**：处理新接口的返回格式
4. **实现批量处理**：支持多个基金代码的并行请求
5. **测试验证**：确保功能正常工作
6. **验证依赖**：确保所有使用该接口的功能不受影响

## 预期结果

- API接口成功替换为天天基金网接口
- 保持与原接口相同的功能和返回格式
- 能够获取基金的实时估值数据
- 所有依赖该接口的功能正常工作